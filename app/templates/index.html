{% extends 'base_dashboard.html' %}

{% block title %}Dashboard{% endblock %}

{% block header %}
    <div class="header pb-8 pt-5 pt-md-8">
        <div class="container-fluid">
            <div class="header-body">
                <!-- Card stats -->
                <div class="row">
                    <div class="col">
                        <form>
                            <div class="form-group">
                                <label for="select-location" class="text-white text-uppercase"><strong>Lokasi</strong></label>
                                <div class="row">
                                    <div class="col-xl-2 col-lg-6 col-sm-3">
                                        <select class="form-control" id="select-location"></select>
                                    </div>
                                    <div class="d-flex">
                                        <button type="button" class="btn btn-icon btn-warning" id="restart-all" data-location="abc">
                                            <span class="btn-inner--icon"><i class="fas fa-refresh"></i></span>
                                            <span class="btn-inner--text">Restart</span>
                                        </button>
                                    </div>
                                    <div class="d-flex">
                                        <button type="button" class="btn btn-icon btn-danger" id="shutdown-all" data-location="abc">
                                            <span class="btn-inner--icon"><i class="fas fa-power-off"></i></span>
                                            <span class="btn-inner--text">Shutdown</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="row" id="computer-group">
                    {#                    {% for computer in computers %}#}
                    {#                        <div class="col-xl-2 col-lg-6 computers" id="computer-{{ computer.computer_id }}">#}
                    {#                            <div class="card card-stats mb-4 mb-xl-0">#}
                    {#                                <div class="card-body">#}
                    {#                                    <div class="row">#}
                    {#                                        <div class="col">#}
                    {#                                            <h5 class="card-title text-uppercase text-muted mb-0">{{ computer.computer_location }}</h5>#}
                    {#                                            <span class="h2 font-weight-bold mb-0">{{ computer.computer_name }}</span>#}
                    {#                                        </div>#}
                    {#                                        <div class="col-auto status">#}
                    {#                                            {% if computer.computer_power_status == 1 %}#}
                    {#                                                <strong><span class="text-success mr-2">On</span></strong>#}
                    {#                                            {% elif computer.computer_power_status == 2 %}#}
                    {#                                                <strong><span class="text-danger mr-2">Re</span></strong>#}
                    {#                                            {% else %}#}
                    {#                                                <strong><span class="text-danger mr-2">Off</span></strong>#}
                    {#                                            {% endif %}#}
                    {#                                        </div>#}
                    {#                                    </div>#}
                    {#                                    <p class="mt-3 mb-0 text-muted text-sm">#}
                    {#                                        <button type="button" class="btn btn-icon btn-warning btn-sm pull-left" onclick="restart_computer('{{ computer.computer_id }}')">#}
                    {#                                            <span class="btn-inner--icon"><i class="fas fa-refresh"></i></span>#}
                    {#                                        </button>#}
                    {#                                        <button type="button" class="btn btn-icon btn-danger btn-sm pull-right" onclick="shutdown_computer('{{ computer.computer_id }}')">#}
                    {#                                            <span class="btn-inner--icon"><i class="fas fa-power-off"></i></span>#}
                    {#                                        </button>#}
                    {#                                    </p>#}
                    {#                                </div>#}
                    {#                            </div>#}
                    {#                        </div>#}
                    {#                    {% endfor %}#}
                </div>
            </div>
        </div>
    </div>
    {#    <div class="container-fluid mt--7">#}
    {#        <footer class="footer">#}
    {#            <div class="row align-items-center justify-content-xl-between">#}
    {#                <div class="col-xl-6">#}
    {#                    <div class="copyright text-center text-xl-left text-muted">#}
    {#                        &copy; 2018 <a href="https://www.creative-tim.com" class="font-weight-bold ml-1" target="_blank">Creative Tim</a>#}
    {#                    </div>#}
    {#                </div>#}
    {#                <div class="col-xl-6">#}
    {#                    <ul class="nav nav-footer justify-content-center justify-content-xl-end">#}
    {#                        <li class="nav-item">#}
    {#                            <a href="https://www.creative-tim.com" class="nav-link" target="_blank">Creative Tim</a>#}
    {#                        </li>#}
    {#                        <li class="nav-item">#}
    {#                            <a href="https://www.creative-tim.com/presentation" class="nav-link" target="_blank">About Us</a>#}
    {#                        </li>#}
    {#                        <li class="nav-item">#}
    {#                            <a href="http://blog.creative-tim.com" class="nav-link" target="_blank">Blog</a>#}
    {#                        </li>#}
    {#                        <li class="nav-item">#}
    {#                            <a href="https://github.com/creativetimofficial/argon-dashboard/blob/master/LICENSE.md" class="nav-link" target="_blank">MIT License</a>#}
    {#                        </li>#}
    {#                    </ul>#}
    {#                </div>#}
    {#            </div>#}
    {#        </footer>#}
    {#    </div>#}
{% endblock %}

{% block js %}
    <!-- Core -->
    <script src="{{ url_for('static', filename='assets/js/plugins/jquery/dist/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/plugins/bootstrap/dist/js/bootstrap.bundle.min.js') }}"></script>
    <!-- Optional JS -->
    <script src="{{ url_for('static', filename='assets/js/plugins/chart.js/dist/Chart.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/plugins/chart.js/dist/Chart.extension.js') }}"></script>
    <!-- Argon JS -->
    <script src="{{ url_for('static', filename='assets/js/argon-dashboard.min.js') }}"></script>
    {#<script src="https://cdn.trackjs.com/agent/v3/latest/t.js"></script>#}
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha512-v8ng/uGxkge3d1IJuEo6dJP8JViyvms0cly9pnbfRxT6/31c3dRWxIiwGnMSWwZjHKOuY3EVmijs7k1jz/9bLA==" crossorigin="anonymous"></script>
    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9/dist/sweetalert2.min.js"></script>
    <script>
        // global variables
        const url = window.location.href;
        const arr = url.split("/");
        const socket_url = arr[0] + "//" + arr[2];
        const socket = io.connect(socket_url);
        let computer_location = [];
        toastr.options = {
            "closeButton": false,
            "debug": false,
            "newestOnTop": false,
            "progressBar": false,
            "positionClass": "toast-bottom-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }

        $(document).ready(function () {
            socket.emit('join_user');
            socket.on('receive_shutdown', function (data) {
                if (data['status'] === 'OK') {
                    let computer_name = data['data']['name'];
                    let computer_location = data['data']['location'];
                    let notification = 'Perintah shutdown sudah terkirim ke ' + computer_name + ' (' + computer_location + ')';
                    toastr['success'](notification);
                    // disable button
                    let computer_id = data['data']['id'];
                    let computer_cmd = data['data']['cmd'];
                    let computer_power_status = data['data']['power_status'];
                    disable_button(computer_id, computer_power_status, computer_cmd);
                }
            });
            socket.on('receive_restart', function (data) {
                if (data['status'] === 'OK') {
                    let computer_name = data['data']['name'];
                    let computer_location = data['data']['location'];
                    let notification = 'Perintah restart sudah terkirim ke ' + computer_name + ' (' + computer_location + ')';
                    toastr['success'](notification);
                    // disable button
                    let computer_id = data['data']['id'];
                    let computer_cmd = data['data']['cmd'];
                    let computer_power_status = data['data']['power_status'];
                    disable_button(computer_id, computer_power_status, computer_cmd);
                }
            });
            socket.on('receive_update', function (data) {
                if (data['status'] === 'OK') {
                    let computer_id = data['data']['id'];
                    let power_status = data['data']['power_status'];
                    change_power_html(computer_id, power_status);

                    // notification
                    let computer_name = data['data']['name']
                    let computer_location = data['data']['location']
                    let notification;
                    if (power_status === 2) {
                        notification = 'Komputer ' + computer_name + ' (' + computer_location + ') sedang restart'
                    } else if (power_status === 1) {
                        notification = 'Komputer ' + computer_name + ' (' + computer_location + ') sudah menyala'
                    } else {
                        notification = 'Komputer ' + computer_name + ' (' + computer_location + ') sudah mati'
                    }
                    toastr['info'](notification);

                    // disable button
                    let computer_cmd = data['data']['cmd'];
                    let computer_power_status = data['data']['power_status'];
                    disable_button(computer_id, computer_power_status, computer_cmd);
                }
            });
            socket.on('receive_location', function (data) {
                let select_location = $('#select-location');
                select_location.empty();
                computer_location = [];
                $.each(data['location'], function (i) {
                    let location = data['location'][i];
                    if (!computer_location.includes(location)) {
                        computer_location.push(location);
                        select_location.append('<option value="' + location + '">' + location + '</option>');
                    }
                });

                // finally initialize computer group
                initialize();
            })
            socket.on('receive_computer', function (data) {
                $('#computer-group').empty();
                $.each(data['computer'], function (i) {
                    let computer_id = data['computer'][i]['id'];
                    let computer_name = data['computer'][i]['name'];
                    let computer_location = data['computer'][i]['location'];
                    let computer_power_status = data['computer'][i]['power_status'];
                    let computer_cmd = data['computer'][i]['cmd'];
                    let power_status;
                    if (computer_power_status === 1) {
                        power_status = '<strong><span class="text-success mr-2">On</span></strong>';
                    } else if (computer_power_status === 2) {
                        power_status = '<strong><span class="text-danger mr-2">Re</span></strong>';
                    } else {
                        power_status = '<strong><span class="text-danger mr-2">Off</span></strong>';
                    }
                    let html = '<div class="d-flex computers kartu-outer" id="computer-' + computer_id + '">' +
                        '                            <div class="card card-stats kartu"' +
                        '                                <div class="card-body">' +
                        '                                    <div class="row">' +
                        '                                        <div class="col">' +
                        '                                            <span class="card-title text-uppercase text-muted mb-0">' + computer_location.substring(0, 4) + '</span>' + '<br/>' +
                        '                                            <span class="h2 font-weight-bold mb-0">' + computer_name + '</span>' +
                        '                                        </div>' +
                        '                                        <div class="col-auto status">' +
                        power_status +
                        '                                        </div>' +
                        '                                    </div>' +
                        '                                    <p class="mt-3 mb-0 text-muted text-sm">' +
                        '                                        <button type="button" class="btn btn-icon btn-warning btn-sm pull-left restart" onclick="restart_computer(\'' + computer_id + '\')">' +
                        '                                            <span class="btn-inner--icon"><i class="fas fa-refresh"></i></span>' +
                        '                                        </button>' +
                        '                                        <button type="button" class="btn btn-icon btn-danger btn-sm pull-right shutdown" onclick="shutdown_computer(\'' + computer_id + '\')">' +
                        '                                            <span class="btn-inner--icon"><i class="fas fa-power-off"></i></span>' +
                        '                                        </button>' +
                        '                                    </p>' +
                        '                                </div>' +
                        '                            </div>' +
                        '                        </div>';
                    $('#computer-group').append(html);
                    // change computer status color
                    let color = $('#computer-' + computer_id + ' .kartu');
                    if (computer_power_status === 2) {
                        color.css('background-color', '#FFCC00');
                    } else if (computer_power_status === 1) {
                        color.css('background-color', 'white');
                    } else {
                        color.css('background-color', 'darkgrey');
                    }
                    disable_button(computer_id, computer_power_status, computer_cmd);
                });
                // change button data location
                $('#shutdown-all').data('location', data['computer'][0]['location']);
                $('#restart-all').data('location', data['computer'][0]['location']);
            });
            socket.on('receive_restart_all', function (data) {
                let notification = 'Perintah restart semua komputer di ' + data['location'] + ' berhasil dikirim';
                let computers = $('.computers');
                if (data['status'] === 'OK') {
                    toastr['success'](notification);
                }
                // disable button
                for (let i=0; i < computers.length; i++) {
                    $('.computers:eq(' + i + ') .restart').prop('disabled', true);
                    let shutdown = $('.computers:eq(' + i + ') .shutdown');
                    let status = $('.computers:eq(' + i + ') .status span').html()
                    if (shutdown.prop('disabled') === true && status !== 'Off' && status !== 'Re') {
                        shutdown.prop('disabled', false);
                    }
                }
            });
            socket.on('receive_shutdown_all', function (data) {
                let notification = 'Perintah shutdown semua komputer di ' + data['location'] + ' berhasil dikirim';
                let computers = $('.computers');
                if (data['status'] === 'OK') {
                    toastr['success'](notification);
                }
                // disable button
                for (let i=0; i < computers.length; i++) {
                    $('.computers:eq(' + i + ') .shutdown').prop('disabled', true);
                    let restart = $('.computers:eq(' + i + ') .restart');
                    let status = $('.computers:eq(' + i + ') .status span').html()
                    if (restart.prop('disabled') === true && status !== 'Off' && status !== 'Re') {
                        restart.prop('disabled', false);
                    }
                }
            });

            get_location();

            $('#select-location').on('change', function () {
                get_computer_group($(this).val());
            });

            $('#restart-all').on('click', function () {
                let location = $(this).data('location');
                Swal.fire({
                    title: 'Apa anda yakin?',
                    text: "Merestart semua komputer di " + location,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya',
                    cancelButtonText: 'Tidak'
                }).then((result) => {
                    if (result.value) {
                        restart_location(location);
                    }
                })
            });

            $('#shutdown-all').on('click', function () {
                let location = $(this).data('location');
                Swal.fire({
                    title: 'Apa anda yakin?',
                    text: "Merestart semua komputer di " + location,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Ya',
                    cancelButtonText: 'Tidak'
                }).then((result) => {
                    if (result.value) {
                        shutdown_location(location);
                    }
                })
            });
        });

        function change_power_html(id, power_status) {
            let status = $('#computer-' + id + ' .status');
            let color = $('#computer-' + id + ' .kartu');
            let html;
            if (power_status === 1) {
                html = '<strong><span class="text-success mr-2">On</span></strong>';
                status.html(html);
                color.css('background-color', 'white')
            } else if (power_status === 2) {
                html = '<strong><span class="text-warning mr-2">Re</span></strong>';
                status.html(html);
                color.css('background-color', '#FFCC00')
            } else {
                html = '<strong><span class="text-danger mr-2">Off</span></strong>';
                status.html(html);
                color.css('background-color', 'darkgrey')
            }
        }

        function shutdown_computer(id) {
            socket.emit('send_shutdown', {
                computer_id: id
            });
        }

        function restart_computer(id) {
            socket.emit('send_restart', {
                computer_id: id
            });
        }

        function get_location() {
            socket.emit('send_location');
        }

        function get_computer_group(location) {
            socket.emit('send_computer', {
                location: location
            });
        }

        function initialize() {
            socket.emit('send_computer', {
                location: $('#select-location').val()
            });
        }

        function shutdown_location(location) {
            socket.emit('send_shutdown_all', {
                location: location
            });
        }

        function restart_location(location) {
            socket.emit('send_restart_all', {
                location: location
            });
        }

        function disable_button(id, power, cmd) {
            let restart_button = $('#computer-' + id + ' .restart');
            let shutdown_button = $('#computer-' + id + ' .shutdown');
            restart_button.prop('disabled', false);
            shutdown_button.prop('disabled', false);
            if (power === 2 || power === 0) {
                restart_button.prop('disabled', true);
                shutdown_button.prop('disabled', true);
            } else if (cmd === 2) {
                restart_button.prop('disabled', true);
            } else if (cmd === 0) {
                shutdown_button.prop('disabled', true);
            }
        }
    </script>
{% endblock js %}